# 工作流系统改造方案

**版本**: V1.0  
**更新时间**: 2024-12-01  
**状态**: ✅ 已完成（95%）

## 一、改造目标

以 OpenAuth.Net 的完整功能实现为基础，结合 TaktXp 的现代化架构优势，构建一个功能完整、架构清晰的工作流系统。

## 二、架构设计

### 2.1 核心组件

```
TaktWorkflowEngine (主引擎)
├── TaktFlowRuntime (运行时引擎 - 基于 OpenAuth.Net) ✅ 已实现
│   ├── TaktFlowNode (节点模型) ✅ 已实现
│   ├── TaktFlowLine (连线模型) ✅ 已实现
│   └── 节点状态管理 ✅ 已实现
├── TaktApproverResolver (审批人解析器) ✅ 已实现
│   └── 9种审批人指定方式 ✅ 已实现
└── 条件分支判断 ✅ 已实现（在TaktFlowLine中）
```

### 2.2 数据模型

#### TaktFlowNode (节点模型) ✅ 已实现
```csharp
public class TaktFlowNode
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Type { get; set; } // start, approval, branch, join, parallel, end
    public SetInfo SetInfo { get; set; } // 运行时状态
    // 注意：已删除 ThirdPartyUrl 字段
}
```

#### TaktFlowLine (连线模型) ✅ 已实现
```csharp
public class TaktFlowLine
{
    public string Id { get; set; }
    public string From { get; set; }
    public string To { get; set; }
    public List<DataCompare> Compares { get; set; } // 条件判断
    public bool Compare(JObject formData); // 条件评估方法
}
```

#### SetInfo (节点运行时状态) ✅ 已实现
```csharp
public class SetInfo
{
    public int? Taged { get; set; } // 1:通过 2:不通过 3:驳回
    public string UserId { get; set; }
    public string UserName { get; set; }
    public string Description { get; set; }
    public string TagedTime { get; set; }
    public string NodeDesignate { get; set; } // 审批人指定方式
    public NodeDesignateData NodeDesignateData { get; set; }
    public string NodeConfluenceType { get; set; } // one/all
    public int? ConfluenceOk { get; set; }
    public int? ConfluenceNo { get; set; }
    public string NodeRejectType { get; set; } // 驳回方式
    // 注意：已删除 ThirdPartyUrl 字段
}
```

## 三、核心功能实现

### 3.1 TaktFlowRuntime 运行时引擎 ✅ 已实现

**位置**: `backend/src/Takt.Application/Services/Workflow/Engine/Runtime/TaktFlowRuntime.cs`

**功能**:
1. ✅ 初始化流程实例（从 TaktInstance 创建运行时对象）
2. ✅ 节点状态管理
3. ✅ 获取下一个节点
4. ✅ 判断流程是否完成
5. ✅ 网关处理
6. ✅ 会签处理
7. ✅ 驳回处理
8. ✅ 撤回处理
9. ✅ 撤销审批
10. ❌ 第三方回调（已删除，不需要）

### 3.2 网关处理逻辑 ✅ 已实现

**位置**: `backend/src/Takt.Application/Services/Workflow/Engine/Runtime/TaktFlowRuntime.cs` → `VerifyGatewayStart()`

**功能**:
1. ✅ 支持 one/all 两种汇聚方式
2. ✅ 网关分支独立审批
3. ✅ 网关汇聚判断
4. ✅ 记录网关状态

### 3.3 会签处理逻辑 ✅ 已实现

**位置**: `backend/src/Takt.Application/Services/Workflow/Engine/Runtime/TaktFlowRuntime.cs` → `GetMultiInstanceNodeMakersAsync()`

**功能**:
1. ✅ 顺序会签
2. ✅ 并行会签（并行且/并行或）
3. ✅ 通过 TaktApprover 表管理会签人员
4. ✅ 会签完成判断

### 3.4 条件分支判断 ✅ 已实现

**位置**: `backend/src/Takt.Domain/Models/Workflow/TaktFlowLine.cs` → `Compare()`

**功能**:
1. ✅ 支持多种比较操作符（>, <, =, >=, <=, !=, IN, LIKE）
2. ✅ 支持 checkbox 特殊处理
3. ✅ 基于表单数据的条件判断

### 3.5 审批人解析器 ✅ 已实现

**位置**: `backend/src/Takt.Application/Services/Workflow/Engine/Resolvers/TaktApproverResolver.cs`

**支持的9种方式**:
1. ✅ 所有成员 (ALL_USER)
2. ✅ 指定用户 (SPECIAL_USER)
3. ✅ 指定角色 (SPECIAL_ROLE)
4. ✅ 指定部门 (SPECIAL_DEPT)
5. ✅ 部门负责人 (DEPT_MANAGER)
6. ✅ 用户直属上级 (USER_PARENT)
7. ✅ 运行时指定用户 (RUNTIME_SPECIAL_USER)
8. ✅ 运行时指定角色 (RUNTIME_SPECIAL_ROLE)
9. ✅ 特殊SQL (SPECIAL_SQL)

## 四、实施步骤

### 阶段一：基础模型和运行时引擎 ✅ 已完成

1. ✅ **创建 TaktFlowNode 和 TaktFlowLine 模型**
   - 文件: `backend/src/Takt.Domain/Models/Workflow/TaktFlowNode.cs`
   - 文件: `backend/src/Takt.Domain/Models/Workflow/TaktFlowLine.cs`
   - 文件: `backend/src/Takt.Domain/Models/Workflow/TaktWorkflowConfigModel.cs` (包含SetInfo)

2. ✅ **创建 TaktFlowRuntime 运行时引擎**
   - 文件: `backend/src/Takt.Application/Services/Workflow/Engine/Runtime/TaktFlowRuntime.cs`
   - 功能: 初始化、节点管理、状态管理

3. ✅ **条件判断功能**
   - 位置: `TaktFlowLine.Compare()` 方法
   - 功能: 条件分支判断

### 阶段二：核心功能实现 ✅ 已完成

1. ✅ **实现网关处理**
   - 位置: `TaktFlowRuntime.VerifyGatewayStart()`
   - 功能: 网关开始/结束处理

2. ✅ **实现会签处理**
   - 位置: `TaktFlowRuntime.GetMultiInstanceNodeMakersAsync()`
   - 功能: 会签节点处理

3. ✅ **实现审批人解析器**
   - 文件: `backend/src/Takt.Application/Services/Workflow/Engine/Resolvers/TaktApproverResolver.cs`
   - 功能: 9种审批人指定方式

### 阶段三：高级功能 ✅ 已完成

1. ✅ **实现驳回功能**
   - 位置: `TaktFlowRuntime.RejectNode()`
   - 功能: 前一步/第一步/指定节点驳回

2. ✅ **实现撤销审批**
   - 位置: `TaktFlowRuntime.UndoVerification()`
   - 功能: 撤销最后一个审批

3. ✅ **实现召回流程**
   - 位置: `TaktFlowRuntime.ReCall()`
   - 功能: 召回流程到开始节点

### 阶段四：集成和优化 ✅ 已完成

1. ✅ **集成到 TaktWorkflowEngine**
   - 修改 `TaktWorkflowEngine` 使用 `TaktFlowRuntime`
   - 保持接口不变，内部实现替换

2. ❌ **第三方回调（已删除）**
   - 原因: TaktXp不需要第三方回调功能
   - 已从 `TaktFlowNode.SetInfo` 中删除 `ThirdPartyUrl` 字段

3. ⏳ **优化和测试（进行中）**
   - 单元测试
   - 集成测试
   - 性能优化

## 五、关键代码实现要点

### 5.1 TaktFlowRuntime 初始化 ✅ 已实现

```csharp
public class TaktFlowRuntime
{
    private readonly TaktInstance _instance;
    private readonly Dictionary<string, TaktFlowNode> _nodes;
    private readonly List<TaktFlowLine> _lines;
    private readonly Dictionary<string, List<TaktFlowLine>> _fromNodeLines;
    private readonly Dictionary<string, List<TaktFlowLine>> _toNodeLines;
    
    public TaktFlowRuntime(TaktInstance instance, TaktWorkflowConfigModel? config = null)
    {
        _instance = instance ?? throw new ArgumentNullException(nameof(instance));
        
        // 如果未提供配置，从实例的 SchemeConfig 解析
        if (config == null)
        {
            config = JsonConvert.DeserializeObject<TaktWorkflowConfigModel>(instance.SchemeConfig);
        }
        
        InitNodes(config);
        InitLines(config);
        
        CurrentNodeId = instance.CurrentNodeId ?? GetStartNodeId();
    }
}
```

### 5.2 网关处理关键逻辑 ✅ 已实现

**位置**: `TaktFlowRuntime.VerifyGatewayStart()`

```csharp
public string VerifyGatewayStart(Tag tag)
{
    // 1. 标记网关开始节点
    MakeTagNode(CurrentNodeId, tag);
    
    // 2. 寻找可审核的分支节点
    string canCheckId = GetOneForkLineCanCheckNodeId(...);
    
    // 3. 标记审核节点
    MakeTagNode(canCheckId, tag);
    
    // 4. 判断网关汇聚
    if (NodeConfluenceType == "one")
    {
        // 至少一个通过即可
        if (tag.Taged == TagState.Ok && nextNode.Type == "join")
        {
            return GetNextNodeId(nextNode.Id);
        }
    }
    else // all
    {
        // 全部通过
        if (ConfluenceOk == forkNumber - 1)
        {
            return GetNextNodeId(nextNode.Id);
        }
    }
}
```

### 5.3 会签处理关键逻辑 ✅ 已实现

**位置**: `TaktFlowRuntime.GetMultiInstanceNodeMakersAsync()`

```csharp
public async Task<List<long>> GetMultiInstanceNodeMakersAsync(string nodeId, ...)
{
    var node = _nodes[nodeId];
    List<long> makerList = // 获取会签人员列表（通过TaktApproverResolver）
    
    // 写入到 TaktApprover 表
    foreach (var userId in makerList)
    {
        var approver = new TaktApprover
        {
            InstanceId = InstanceId,
            ActivityId = nodeId,
            ApproverId = userId,
            OrderNo = order++,
            ApproveType = node.SetInfo.NodeConfluenceType,
            Status = 0 // 待审批
        };
        // 保存到数据库
    }
    
    // 顺序执行返回第一个，并行返回所有
    if (node.SetInfo.NodeConfluenceType == "sequential")
    {
        return new List<long> { makerList[0] };
    }
    return makerList;
}
```

### 5.4 条件分支判断 ✅ 已实现

**位置**: `TaktFlowLine.Compare()`

```csharp
public bool Compare(JObject formData)
{
    if (Compares == null || !Compares.Any())
        return true;
    
    bool result = true;
    foreach (var compare in Compares)
    {
        var fieldValue = formData[compare.FieldName.ToLower()];
        
        switch (compare.Operation)
        {
            case ">": result &= CompareValue(fieldValue, compare.Value, ">"); break;
            case "<": result &= CompareValue(fieldValue, compare.Value, "<"); break;
            case "=": result &= CompareValue(fieldValue, compare.Value, "="); break;
            case "IN": result &= compare.ValueList.Contains(fieldValue); break;
            case "LIKE": result &= fieldValue.ToString().Contains(compare.Value); break;
            // ... 其他操作符
        }
    }
    
    return result;
}
```

## 六、数据库表设计

### 6.1 TaktApprover (审批人表)

```sql
CREATE TABLE Takt_workflow_approver (
    id BIGINT PRIMARY KEY,
    instance_id BIGINT NOT NULL,
    activity_id NVARCHAR(50) NOT NULL,
    approver_id BIGINT NOT NULL,
    approver_name NVARCHAR(100),
    order_no INT,
    approve_type NVARCHAR(20), -- sequential, parallel_and, parallel_or
    status INT DEFAULT 0, -- 0:待审批 1:已通过 2:已拒绝
    verify_comment NVARCHAR(500),
    verify_date DATETIME,
    return_to_sign_node BIT DEFAULT 0,
    reason NVARCHAR(500),
    create_date DATETIME,
    create_user_id BIGINT,
    create_user_name NVARCHAR(100)
);
```

## 七、已删除功能

### 7.1 不需要的字段

| 字段 | 位置 | 说明 |
|------|------|------|
| `WebId` | `TaktForm` | 系统页面标识，TaktXp不需要 |
| `FrmHtml` | 响应DTO | 表单HTML，TaktXp前端自行渲染 |
| `FrmPreviewHtml` | 响应DTO | 预览HTML，TaktXp前端自行渲染 |
| `ThirdPartyUrl` | `TaktFlowNode.SetInfo` | 第三方回调URL，TaktXp不需要 |
| `TransState` | `TaktInstanceTrans` | 转化状态，与Status重复，已删除 |
| `IsFinish` | `TaktInstanceTrans` | 是否完成，与Status重复，已删除 |

### 7.2 已删除的功能模块

- ❌ **第三方回调**: 节点级别的回调功能，TaktXp不需要
- ❌ **HTML渲染**: 表单HTML渲染功能，前端自行处理
- ❌ **调度器模块**: WorkflowScheduler、AutoExecutionJob、TimeoutReminderJob、CleanupJob（已移除）

## 八、实施状态总结

### 8.1 完成度

**总体评估**: ✅ **95% 完成**

**各层完成度**:
- **实体层**: ✅ 100% 完成（已删除不需要的字段）
- **服务层**: ✅ 95% 完成（核心逻辑一致，架构更优）
- **控制器层**: ✅ 90% 完成（RESTful设计，功能更全）
- **前端层**: ✅ 95% 完成（TypeScript类型安全）
- **核心组件**: ✅ 100% 完成（逻辑完全一致）

### 8.2 主要优势

1. ✅ **架构清晰**: 使用 `TaktFlowRuntime` 封装核心逻辑，避免重复代码
2. ✅ **现代化设计**: 全面使用异步、依赖注入、TypeScript
3. ✅ **类型安全**: 完整的类型定义和类型检查
4. ✅ **RESTful API**: 规范的API设计
5. ✅ **功能完整**: 核心功能与OpenAuth.Net一致，并删除不需要的功能

## 九、注意事项

1. ✅ **保持接口兼容性**: 改造过程中保持 `ITaktWorkflowEngine` 接口不变
2. ✅ **渐进式迁移**: 先实现核心功能，再逐步完善
3. ⏳ **充分测试**: 每个阶段都要进行充分测试（进行中）
4. ✅ **文档更新**: 及时更新相关文档
5. ⏳ **性能考虑**: 注意网关和会签的性能优化（进行中）

## 十、参考资源

- OpenAuth.Net FlowRuntime.cs
- OpenAuth.Net FlowNode.cs
- OpenAuth.Net FlowLine.cs
- TaktXp TaktWorkflowEngine.cs
- TaktXp TaktFlowRuntime.cs
- 工作流集成对比分析.md（详细对比文档）

